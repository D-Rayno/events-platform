# üöÄ Deployment Guide

Complete guide for deploying G-Agency Events to Render.com

---

## üìã Table of Contents

1. [Prerequisites](#prerequisites)
2. [Quick Start](#quick-start)
3. [Render Deployment](#render-deployment)
4. [Local Development](#local-development)
5. [Environment Variables](#environment-variables)
6. [Database Setup](#database-setup)
7. [Troubleshooting](#troubleshooting)

---

## Prerequisites

### Required

- ‚úÖ Node.js 20+
- ‚úÖ Docker & Docker Compose (for local dev)
- ‚úÖ Git
- ‚úÖ Render.com account (free tier)

### Recommended

- ‚úÖ Database host (PlanetScale, Railway, etc.)
- ‚úÖ Email service (MailerSend, Brevo, etc.)
- ‚úÖ Image hosting (Cloudinary, S3 - for production)

---

## Quick Start

### 1. Clone & Setup

```bash
# Clone repository
git clone <your-repo>
cd g-agency-events

# Make scripts executable
chmod +x scripts/*.sh

# Copy environment template
cp .env.example .env.docker
```

### 2. Local Development

```bash
# Start everything (Docker)
make setup

# Or manual steps
make dev           # Start services
make migrate       # Run migrations
make seed          # Seed database
```

### 3. Deploy to Render

```bash
# Push to GitHub
git push origin main

# Render will automatically deploy using render.yaml
```

---

## Render Deployment

### Option 1: Automatic (Recommended)

1. **Connect Repository**
   - Go to [Render Dashboard](https://dashboard.render.com)
   - Click "New +" ‚Üí "Blueprint"
   - Connect your GitHub repository
   - Render will detect `render.yaml` automatically

2. **Configure Environment**
   - Render will read `render.yaml` for basic config
   - Add sensitive variables in dashboard:
     - `DB_HOST`, `DB_USER`, `DB_PASSWORD`, `DB_DATABASE`
     - `SMTP_HOST`, `SMTP_USERNAME`, `SMTP_PASSWORD`
     - `MAIL_FROM_ADDRESS`

3. **Deploy**
   - Click "Apply"
   - Render will build and deploy automatically
   - First deploy takes ~5-10 minutes

### Option 2: Manual Web Service

1. **Create Web Service**
   - New + ‚Üí Web Service
   - Connect repository
   - Name: `g-agency-events`
   - Region: `Frankfurt` (or nearest)
   - Branch: `main`
   - Runtime: `Node`

2. **Build & Start Commands**

   ```bash
   # Build Command
   npm run render:build

   # Start Command
   npm run render:start
   ```

3. **Environment Variables**
   See [Environment Variables](#environment-variables) section

### Option 3: Docker Deployment

1. **Create Web Service**
   - Choose "Docker" runtime
   - Render will use `Dockerfile` automatically

2. **Configure**

   ```yaml
   # Dockerfile path: ./Dockerfile
   # Docker context: .
   ```

3. **Environment Variables**
   Same as Option 1

---

## Local Development

### Using Make Commands

```bash
# Start development
make dev              # Start all services
make logs             # View logs
make shell            # Access app shell
make status           # Check service status

# Database
make migrate          # Run migrations
make seed             # Seed database
make db-reset         # Reset & reseed

# Typesense
make typesense-setup  # Setup collections
make typesense-index  # Index data

# Utilities
make generate-key     # Generate APP_KEY
make generate-token   # Generate admin token
make routes           # List routes

# Cleanup
make stop             # Stop services
make clean            # Remove everything
make rebuild          # Rebuild from scratch
```

### Using Docker Compose Directly

```bash
# Start
docker compose up -d

# Logs
docker compose logs -f app

# Execute commands
docker compose exec app node ace migration:run
docker compose exec app node ace db:seed

# Stop
docker compose down
```

### Without Docker

```bash
# Install dependencies
npm install

# Setup database (MySQL)
# Create database: events_platform

# Copy environment
cp .env.example .env

# Edit .env with your database credentials

# Run migrations
node ace migration:run

# Seed database
node ace db:seed

# Start development server
npm run dev
```

---

## Environment Variables

### Local Development (.env.docker)

```env
NODE_ENV=development
PORT=3333
HOST=0.0.0.0
APP_KEY=your_generated_key
APP_URL=http://localhost:3333

# Docker service names
DB_HOST=db
TYPESENSE_HOST=typesense

# Database
DB_PORT=3306
DB_USER=g_agency
DB_PASSWORD=secure_password
DB_DATABASE=events_platform

# Email
SMTP_HOST=smtp.mailersend.net
SMTP_PORT=587
SMTP_USERNAME=your_username
SMTP_PASSWORD=your_password
MAIL_FROM_ADDRESS=noreply@yourdomain.com

# Typesense
TYPESENSE_ENABLED=true
TYPESENSE_PORT=8108
TYPESENSE_API_KEY=your_key
```

### Render Production

```env
NODE_ENV=production
PORT=10000
HOST=0.0.0.0
APP_KEY=<auto-generated>
APP_URL=https://your-app.onrender.com

# External database
DB_HOST=your-db-host.com
DB_PORT=3306
DB_USER=your_user
DB_PASSWORD=your_password
DB_DATABASE=your_database

# Email service
SMTP_HOST=smtp.mailersend.net
SMTP_PORT=587
SMTP_USERNAME=your_username
SMTP_PASSWORD=your_password
MAIL_FROM_ADDRESS=noreply@yourdomain.com

# Disable Typesense on free tier
TYPESENSE_ENABLED=false

# Admin token
ADMIN_API_TOKEN=<auto-generated>
```

### Generate Secrets

```bash
# Generate APP_KEY
node ace generate:key

# Generate ADMIN_API_TOKEN
node ace generate:admin-token
```

---

## Database Setup

### Option 1: Render PostgreSQL (Free)

**Note**: Your app currently uses MySQL. To use Render's free PostgreSQL:

1. **Switch to PostgreSQL**

   ```bash
   # Update package.json
   npm uninstall mysql2
   npm install pg
   ```

2. **Update config/database.ts**

   ```typescript
   connection: 'postgres',
   connections: {
     postgres: {
       client: 'pg',
       connection: {
         host: env.get('DB_HOST'),
         port: env.get('DB_PORT'),
         user: env.get('DB_USER'),
         password: env.get('DB_PASSWORD'),
         database: env.get('DB_DATABASE'),
       }
     }
   }
   ```

3. **Create Database in Render**
   - Dashboard ‚Üí New + ‚Üí PostgreSQL
   - Copy internal connection URL
   - Add to environment variables

### Option 2: External MySQL

**Recommended providers** (free tiers available):

- [PlanetScale](https://planetscale.com) - MySQL, generous free tier
- [Railway](https://railway.app) - MySQL, $5 credit/month
- [Aiven](https://aiven.io) - MySQL, free trial

**Setup**:

1. Create MySQL database
2. Get connection details
3. Add to Render environment variables
4. Whitelist Render's IP ranges (if required)

### Option 3: Local MySQL (Development Only)

```bash
# Using Docker Compose
make dev

# Direct MySQL connection
docker compose exec db mysql -uroot -proot events_platform
```

---

## Troubleshooting

### Build Failures

**Problem**: Build fails on Render

**Solution**:

```bash
# Check build logs in Render dashboard
# Common issues:

# 1. Missing dependencies
npm ci --omit=dev

# 2. TypeScript errors
node ace build --ignore-ts-errors

# 3. Theme generation fails
node scripts/generate-theme.cjs
```

### Database Connection

**Problem**: Can't connect to database

**Solutions**:

1. Check connection string format
2. Verify firewall/IP whitelist
3. Test connection:
   ```bash
   node ace db:check
   ```

### Migrations Fail

**Problem**: Migrations don't run

**Solutions**:

```bash
# Check migration status
node ace migration:status

# Run manually
node ace migration:run --force

# Reset (‚ö†Ô∏è deletes data)
node ace migration:rollback --force
node ace migration:run
```

### Upload Issues

**Problem**: File uploads don't persist

**Cause**: Render free tier has ephemeral storage

**Solutions**:

1. **Use Cloudinary** (recommended)
   ```bash
   npm install @adonisjs/drive-cloudinary
   ```
2. **Use Render Disk** (paid)
   - Add disk mount in `render.yaml`
3. **Use S3** (AWS)
   ```bash
   npm install @adonisjs/drive-s3
   ```

### Typesense on Render

**Problem**: Typesense not available

**Cause**: Free tier doesn't support long-running containers

**Solutions**:

1. **Disable Typesense** (easiest)

   ```env
   TYPESENSE_ENABLED=false
   ```

2. **Use Typesense Cloud** (paid)
   - Sign up at typesense.org/cloud
   - Get API key
   - Update environment variables

3. **Upgrade Render Plan** ($7/month)

### Slow Cold Starts

**Problem**: App takes 30+ seconds to start after inactivity

**Cause**: Render free tier spins down after 15 minutes

**Solutions**:

1. **Accept it** (it's free!)
2. **Keep-alive service** (ping every 14 minutes)
3. **Upgrade to paid plan** ($7/month, no spin down)

### Environment Variable Issues

**Problem**: App can't read environment variables

**Solutions**:

```bash
# 1. Check Render dashboard
# Ensure all variables are set

# 2. Check case sensitivity
# Render is case-sensitive

# 3. Sync variables
# Click "Sync" in Render dashboard

# 4. Manual deploy
# Click "Manual Deploy" ‚Üí "Deploy latest commit"
```

---

## üéØ Deployment Checklist

Before deploying to production:

- [ ] ‚úÖ Generate `APP_KEY`
- [ ] ‚úÖ Generate `ADMIN_API_TOKEN`
- [ ] ‚úÖ Setup external database
- [ ] ‚úÖ Configure email service
- [ ] ‚úÖ Test database connection
- [ ] ‚úÖ Run migrations
- [ ] ‚úÖ Decide on file storage strategy
- [ ] ‚úÖ Disable or configure Typesense
- [ ] ‚úÖ Update `APP_URL` in environment
- [ ] ‚úÖ Test build locally: `npm run render:build`
- [ ] ‚úÖ Push to GitHub
- [ ] ‚úÖ Deploy on Render
- [ ] ‚úÖ Check health endpoint
- [ ] ‚úÖ Test login and features

---

## üìö Additional Resources

- [Render Documentation](https://render.com/docs)
- [AdonisJS Deployment Guide](https://docs.adonisjs.com/guides/deployment)
- [Docker Best Practices](https://docs.docker.com/develop/dev-best-practices/)
- [PlanetScale MySQL](https://planetscale.com/docs)
- [MailerSend Setup](https://www.mailersend.com/help)

---

## üÜò Getting Help

If you encounter issues:

1. Check [Troubleshooting](#troubleshooting) section
2. Review Render build/deploy logs
3. Check application logs
4. Search Render community forum
5. Open GitHub issue with:
   - Error messages
   - Build logs
   - Environment (anonymized)

---

## üìä Cost Breakdown

### Free Tier (Render)

- ‚úÖ Web Service: Free (with limits)
- ‚úÖ PostgreSQL: Free (limited)
- ‚ùå Persistent Disk: Not available
- ‚ùå Multiple containers: Not available

### Paid Tier ($7/month)

- ‚úÖ Web Service: No spin down
- ‚úÖ Persistent disk: 1GB free
- ‚úÖ Better performance
- ‚úÖ Support

### External Services (Optional)

- Database: $0-5/month (PlanetScale free tier)
- Email: $0-15/month (MailerSend free tier)
- Storage: $0-10/month (Cloudinary free tier)
- Typesense: $0-50/month (Cloud hosting)

**Total**: $0-97/month depending on needs

---

## üéâ Success!

Once deployed, your app will be available at:

```
https://your-app-name.onrender.com
```

Default admin credentials:

- Email: `admin@events.dz`
- Password: `Admin@123`

**‚ö†Ô∏è Change default password immediately!**
